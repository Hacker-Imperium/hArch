#!/usr/bin/env bash

# ---------------------------------------------------------------
#hArchPost - Post install - Downloadeded after hArch finishes    |
# ---------------------------------------------------------------
# Author    : Binary-Brawler                                     |
# Github    : github.com/Hacker-Imperium                         |
# LinkedIn  : linkedin.com/in/brandon-walker-0b0542116/          |
# Version   : 1.1.4                                              |
# Intent    : Post install script for hArch                      |
# ---------------------------------------------------------------
#                  Function - Purpose                            |
# -----------------------------------------------------------------------------------
# slear                       - Repeated Sleep/Clear function                        |
# greeter                     - Entrypoint                                           |
# collect_Inputs              - Collects inputs from user (Memory cleared at end)    |
# p_Download                  - Checks boolean value from previous script            |
# installer                   - Set Hostname & install useful packages               |
# desktop_Env                 - Sets MATE by default (low specs)                     |
# dev_Setup                   - Installs coders env i.e. IDE's, Languages and vimrc  |
# vid_driver                  - Installs driver based off lspci                      |
# user_Info                   - Set ROOT pass and create user account                |
# booter                      - Bootloader function, eventually will be automated    |
# black_Arch                  - Install BlackArch Repository                         |
# hack_Tools                  - Installs tools or skip                               |
# complete                    - Finish last minute setup and cleanup                 |
# one_Func_To_Rule_Them_All   - Iterative function to run functions                  |
# and_In_The_Script_Bind_Them - Encoded functions to run                             |
# -----------------------------------------------------------------------------------

# Constants
GREEN='\033[0;32m'
RED='\033[0;31m'
WHITE='\033[0;37m'
YELLOW='\033[0;33m'
PURPLE='\033[0;35m'
RESET='\033[0m'
NEWLINE=$'\n'
GITHUB='https://raw.githubusercontent.com/Hacker-Imperium'

# Logging
log_warning() { echo -e "[${YELLOW}WARNING${RESET}] $1"; }
log_error() { echo -e "[${RED}ERROR${RESET}] $1"; }
print_info() { echo -e "[${GREEN}INFO${RESET}] $1${NEWLINE}"; }
log_success() {
    local num_quotes=${#motivational_quotes[@]}
    local random_index=$((RANDOM % num_quotes))
    local random_quote="${motivational_quotes[$random_index]}"
    echo -e "${GREEN}[SUCCESS]${RESET} $1"
    echo ${NEWLINE}
    echo ${NEWLINE}
    echo "Motivational Quote: $random_quote"
    echo ${NEWLINE}
    echo ${NEWLINE}
}

motivational_quotes=(
    "Success is not final, failure is not fatal: It is the courage to continue that counts. - Winston Churchill"
    "Hardships often prepare ordinary people for an extraordinary destiny. - C.S. Lewis"
    "Believe you can and you're halfway there. - Theodore Roosevelt"
    "The only limit to our realization of tomorrow will be our doubts of today. - Franklin D. Roosevelt"
    "It does not matter how slowly you go as long as you do not stop. - Confucius"
    "You are never too old to set another goal or to dream a new dream. - C.S. Lewis"
    "The only way to achieve the impossible is to believe it is possible. - Charles Kingsleigh (Alice in Wonderland)"
)

function slear {
    sleep 3
    clear
}

function collect_Inputs {
    slear
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Collecting all required inputs at the beginning..."
    echo "-------------------------------------------------------------------------------------------------"
    echo ${NEWLINE}

    # Hostname
    echo "-------------------------------------------------------------------------------------------------"
    print_info "System Configuration:"
    read -p "Enter Hostname: " HOSTNAME
    echo "-------------------------------------------------------------------------------------------------"
    # User account
    echo "-------------------------------------------------------------------------------------------------"
    print_info "User Account Setup:"
    read -p "Enter Username: " USERNAME
    echo "-------------------------------------------------------------------------------------------------"
    # Passwords
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Password Configuration:"
    echo "You will be prompted for passwords. They will be set non-interactively."
    read -sp "Enter ROOT password: " ROOT_PASSWORD
    echo ""
    read -sp "Enter password for $USERNAME: " USER_PASSWORD
    echo ""
    echo "-------------------------------------------------------------------------------------------------"

    print_info "All inputs collected (stored in memory only)."
    sleep 2

}


function p_Download {
    slear
    echo "--------------------------------"
    enable_parallel=$(cat /enable_parallel.txt)

    if [ "$enable_parallel" = "true" ]; then
        sed -i '/#ParallelDownloads/s/^#//g' /etc/pacman.conf
        print_info "Parallel Downloads Enabled."
        rm /enable_parallel.txt
    else
        print_info "Parallel Downloads Disabled."
        rm /enable_parallel.txt
    fi
}

function installer {
    echo "-------------------------------------------------------"
    print_info "Setting hostname to $HOSTNAME..."
    echo $HOSTNAME > /etc/hostname
    slear
    echo  "----------------------------------------------------"
    print_info "Installing useful packages... Grab a coffee!" 
    pacman -S dkms linux-headers mlocate git cmake fastfetch tree firefox samba cherrytree lsof flameshot net-tools dnsutils dconf fish remmina dconf-editor rxvt-unicode ranger rofi dmenu terminator chromium --noconfirm >/dev/null 2>&1
    hwclock --systohc
}

function desktop_Env {
    echo "-------------------------------"
    print_info "Setting up Mate DE..."
    pacman -S  mate mate-extra lightdm lightdm-gtk-greeter xorg xorg-server xorg-apps xorg-xinit --noconfirm >/dev/null 2>&1
    systemctl enable lightdm >/dev/null 2>&1
    sleep 3
    echo "----------------------------------------------------------------------------------------------------------"
    print_info "Downloading MATE desktop configuration... Efficient for low spec systems, change as you see fit"
    if curl -O $GITHUB/hArch/blob/main/conf/linux-vs-windows.jpg >/dev/null 2>&1; then
        if mv /linux-vs-windows.jpg /usr/share/backgrounds/mate/desktop/linux-vs-windows.jpg; then
            print_info "✓ Desktop background downloaded and installed"
        else
            log_error "Failed to install desktop background"
        fi
    else
        log_error "Failed to download desktop background"
    fi
    
    if curl -O $GITHUB/hArch/refs/heads/main/conf/MateConfig >/dev/null 2>&1; then
        print_info "✓ MATE configuration downloaded"
    else
        log_error "Failed to download MATE configuration"
    fi
}

function dev_Setup {
    echo "--------------------------------"
    read -p "Can you code? [Y/n]: " CODER
    if [[ $CODER == 'y' || $CODER == 'Y' || -z "$CODER" ]]; then
        echo "-------------------------------------------------------"
        print_info "Setting up a coding env... This may take awhile"
        echo "-------------------------------------------------------"
        print_info "Downloading vim configuration..."
        if curl -O $GITHUB/hArch/refs/heads/main/vimrc_bundle_conf >/dev/null 2>&1; then
            if mv vimrc_bundle_conf /home/$USERNAME/.vimrc; then
                print_info "✓ vim configuration installed"
            else
                log_error "Failed to install vim configuration"
            fi
        else
            log_error "Failed to download vim configuration"
        fi

        echo "-----------------------------------------------------------------"
        print_info "Installing programming languages and tools:"
        echo "  • Java (OpenJDK)"
        echo "  • Python 3 (with pip)"
        echo "  • Rust (via rustup)"
        echo "  • Go"
        echo "  • Node.js & npm (JavaScript)"
        echo "  • Haskell (available via 'installHaskell' function in fish)"
        echo "-----------------------------------------------------------------"
        print_info "Installing IDEs and development tools..."
        echo "  • Visual Studio Code"
        echo "  • Neovim"
        echo "  • PyCharm Community Edition"
        echo "  • IntelliJ IDEA Community Edition"
        echo "-----------------------------------------------------------------"
        print_info "Installing containerization and virtualization:"
        echo "  • Docker (container platform)"
        echo "  • VirtualBox (virtualization)"
        echo "  • Python virtual environments (venv support via pip)"
        echo "-----------------------------------------------------------------"
        sleep 2
        pacman -S jdk-openjdk python-pip rustup go nodejs npm python3 code neovim gimp audacity wireshark-qt vlc btop virtualbox postman docker pycharm-community-edition intellij-idea-community-edition --noconfirm >/dev/null 2>&1 
    else
        log_warning "Do you know where the term Script Kiddie comes from?"
        slear
    fi
}


function vid_Driver {
    echo "--------------------------------------"
    print_info "Gathering Graphics info..."
    sleep 2
    str=$(lspci -vmm | grep VGA -A6)
    user=$USERNAME
    
    # Define driver packages
    AMD='AMD'
    NVD='NVIDIA'
    Turing='nvidia-open'
    Maxwell='nvidia'
    Kepler='nvidia-470xx-utils'
    Fermi='nvidia-390xx-utils'
    Tesla='nvidia-340xx-utils'
    
    case $str in
        *"$AMD"*)
            print_info "Installing AMD Drivers..."
            echo "------------------------------------"
            pacman -S xf86-video-ati xf86-video-amdgpu mesa --noconfirm >/dev/null
            ;;
        *"$NVD"*)
            # Check Nvidia GPU architecture
            if echo "$str" | grep -q "NV160\|TU"; then
                driver=$Turing
            elif echo "$str" | grep -q "NV110\|GM"; then
                driver=$Maxwell
            elif echo "$str" | grep -q "NVE0\|GK"; then
                driver=$Kepler
            elif echo "$str" | grep -q "NVC0\|GF"; then
                driver=$Fermi
            elif echo "$str" | grep -q "NV50\|G8"; then
                driver=$Tesla
            else
                print_info "Unable to determine specific Nvidia architecture. Installing the default driver..."
                print_info "Check dmesg for any driver issues..."
                driver=$Maxwell # Fallback to a common driver
            fi
            
            print_info "Installing Nvidia Drivers: $driver..."
            echo "-------------------------------------"
            if [[ $driver == "nvidia-open" || $driver == "nvidia" ]]; then
                # Install for Turing and Maxwell
                pacman -S "$driver" nvidia-settings nvidia-utils glxinfo nvtop --noconfirm >/dev/null
            else
                pacman -S nvidia-settings glxinfo nvtop --noconfirm >/dev/null
                git clone "https://aur.archlinux.org/$driver.git" /tmp/$driver
                cd /tmp/$driver
                su $user
                makepkg -si --noconfirm
                cd -
                #rm -rf /tmp/$driver
            fi

            print_info "Downloading NVIDIA configuration files..."
            if curl -O $GITHUB/hArch/refs/heads/main/conf/nvidia.hook 2>/dev/null && curl -O $GITHUB/hArch/refs/heads/main/conf/20-nvidia.conf 2>/dev/null; then
                print_info "✓ NVIDIA configuration files downloaded successfully"
                mkdir -p /etc/pacman.d/hooks/ /etc/X11/xorg.conf.d/
                if mv /nvidia.hook /etc/pacman.d/hooks/ && mv /20-nvidia.conf /etc/X11/xorg.conf.d/; then
                    print_info "✓ NVIDIA configuration files installed"
                else
                    log_error "Failed to move NVIDIA configuration files"
                fi
            else
                log_error "Failed to download NVIDIA configuration files"
            fi
            echo "blacklist nouveau" > /etc/modprobe.d/blacklist-nvidia-nouveau.conf
            echo "-------------------------------------------------------------"
            print_info "Attempting to force composition..."
            print_info "[!] Usually fixes screen tearing w/ Nvidia drivers..."
            #bash -c "nvidia-settings --assign CurrentMetaMode=\"$(nvidia-settings -q CurrentMetaMode -t | sed 's/"/\\"/g; s/}/, ForceCompositionPipeline = On}/')\""
            ;;
        *)
            print_info "Unable to determine Graphics info.. Installing default drivers"
            echo "----------------------------------------------------------------------"
            pacman -S xf86-video-fbdev --noconfirm
    esac
}

function user_Info {
    echo "-------------------------------------------------"
    print_info "Setting Root password..."
    echo "root:$ROOT_PASSWORD" | chpasswd || log_error "Failed to set password for ROOT"
    unset ROOT_PASSWORD
    slear
    echo "-------------------------------------------------"
    print_info "Creating user account: $USERNAME..."
    
    # Determine shell - use fish if available, otherwise use bash
    local user_shell="/bin/bash"
    if command -v fish &>/dev/null; then
        user_shell="/usr/bin/fish"
        print_info "Setting Fish shell"
    else
        log_warning "Fish shell not available, using bash as default shell"
    fi
    
    useradd -mg users -G wheel,power,storage -s "$user_shell" $USERNAME
    echo '%wheel ALL=(ALL:ALL) ALL' >> /etc/sudoers.d/wheel_group
    chmod 440 /etc/sudoers.d/wheel_group
    echo "---------------------------------------------"
    print_info "Setting $USERNAME password..."
    echo "$USERNAME:$USER_PASSWORD" | chpasswd || log_error "Failed to set password for user $USERNAME."
    unset USER_PASSWORD
    
    # Only download fish config if fish is installed
    if command -v fish &>/dev/null; then
        print_info "Downloading Fish shell configuration..."
        if curl -O $GITHUB/hArch/refs/heads/main/conf/fish.config >/dev/null 2>&1; then
            print_info "✓ Fish configuration downloaded successfully"
            mkdir -p /home/$USERNAME/.config/fish
            if mv /fish.config /home/$USERNAME/.config/fish/config.fish; then
                print_info "✓ Fish configuration installed"
            else
                log_error "Failed to move Fish configuration file"
            fi
        else
            log_error "Failed to download Fish configuration"
            log_warning "Fish will use default configuration"
        fi
    else
        log_warning "Skipping Fish configuration (Fish shell not installed)"
    fi
    chown $USERNAME -R /home/$USERNAME/.config/
    mkdir -p /home/$USERNAME/AUR
    chown -R $USERNAME /home/$USERNAME/AUR
    mkdir -p /home/$USERNAME/HacktheBox
    chown -R $USERNAME /home/$USERNAME/HacktheBox
    mkdir -p /home/$USERNAME/TryHackMe
    chown -R $USERNAME /home/$USERNAME/TryHackMe
    mkdir -p /home/$USERNAME/Workspace
    chown -R $USERNAME /home/$USERNAME/Workspace
    print_info "Downloading Samba configuration... You'll need for for HacktheBox and TryHackMe"
    if curl -O $GITHUB/hArch/refs/heads/main/conf/smb.conf >/dev/null 2>&1; then
        print_info "✓ Samba configuration downloaded successfully"
        
        # Ensure /etc/samba directory exists
        if [[ ! -d "/etc/samba" ]]; then
            print_info "Creating /etc/samba directory..."
            mkdir -p /etc/samba
        fi
        
        # Move the configuration file
        if mv /smb.conf /etc/samba/smb.conf; then
            print_info "✓ Samba configuration installed to /etc/samba/smb.conf"
        else
            log_error "Failed to move smb.conf to /etc/samba/"
        fi
    else
        log_error "Failed to download smb.conf from GitHub"
        log_warning "Samba will use default configuration"
    fi
}

function booter {
    echo "-----------------------------"
    print_info "Setting Bootloader..."
    drives=$(lsblk -f)
    echo -e "$drives${NEWLINE}"
    echo -e "[${YELLOW}SYNTAX${RESET}] If BIOS, attach bootloader to disk: ex- /dev/sda"
    echo -e "[${YELLOW}SYNTAX${RESET}] If UEFI, attach bootloader to partition: ex- /dev/nvme0n1p1"
    echo "-----------------------------------------------------------------------------------------------------"
    read -p "Enter Drive/Partition to install Bootloader [Example: /dev/nvme0n1p1]: " BOOTLOADER_DRIVE
    slear
    
    # Use firmware type detected by hArch script
    local is_uefi=false
    if [[ -f "/firmware_type.txt" ]]; then
        is_uefi=$(cat /firmware_type.txt)
        if [[ "$is_uefi" == "true" ]]; then
            print_info "Using UEFI firmware (detected by hArch)"
        else
            print_info "Using BIOS firmware (detected by hArch)"
        fi
        rm /firmware_type.txt
    else
        # Fallback to detection if file not found
        log_warning "firmware_type.txt not found, falling back to detection"
        if [[ -d "/sys/firmware/efi/efivars/" ]] && [[ -d "/sys/firmware/efi" ]] && [[ -f "/sys/firmware/efi/fw_platform_size" ]]; then
            if ls /sys/firmware/efi/efivars/ >/dev/null 2>&1; then
                is_uefi=true
                print_info "Detected UEFI firmware"
            else
                print_info "EFI directory exists but variables not accessible - treating as BIOS"
            fi
        else
            print_info "Detected BIOS firmware"
        fi
    fi
    
    if [[ "$is_uefi" == "true" ]]; then
        echo "-------------------------------------"
        print_info "Installing UEFI Bootloader..."
        pacman -S efibootmgr grub dosfstools mtools os-prober --noconfirm >/dev/null
        grub-install --target=x86_64-efi --bootloader-id=HARCH_UEFI --efi-directory=/boot/EFI --recheck
        grub-mkconfig -o /boot/grub/grub.cfg
        mkinitcpio -p linux
    else
        echo "---------------------------------------------"
        print_info "Installing BIOS Bootloader..."
        pacman -S grub --noconfirm >/dev/null
        grub-install --target=i386-pc $BOOTLOADER_DRIVE --recheck
        grub-mkconfig -o /boot/grub/grub.cfg
        mkinitcpio -p linux
    fi
}

function black_Arch {
    echo "-----------------------------------------------------------"
    print_info "Installing BlackArch Repo and setting up keyring..."
    curl -O 'https://blackarch.org/strap.sh' >/dev/null 2>&1
    chmod +x strap.sh
    ./strap.sh >/dev/null
    sleep 3
    rm /strap.sh
    print_info "Updating Blackarch Keyring"
    pacman -Syu --noconfirm >/dev/null 2>&1
}

function hack_Tools {
    echo "-----------------------------------------------------------------------------------------"
    print_info "Hacking Tools Installation"
    echo "-----------------------------------------------------------------------------------------"
    echo ""
    echo "Select which tool categories you want to install:"
    echo ""
    echo "  [1] Cracking      - Password cracking tools (john, hashcat, hydra, etc.)"
    echo "  [2] Network       - Network and web tools (nmap, burpsuite, metasploit, etc.)"
    echo "  [3] Forensics     - Forensics tools (binwalk, steghide, radare2, etc.)"
    echo "  [4] Pwn           - Exploitation and reverse engineering (ghidra, pwntools, etc.)"
    echo "  [5] Wireless      - Wireless security tools (aircrack-ng, kismet, reaver, etc.)"
    echo "  [6] OSINT         - Open source intelligence (theharvester, recon-ng, maltego, etc.)"
    echo "  [7] Mobile        - Mobile security tools (apktool, frida, drozer, etc.)"
    echo "  [8] Malware       - Malware analysis tools (volatility3, yara, cuckoo, etc.)"
    echo "  [9] Master        - All tools combined (everything above)"
    echo ""
    echo "You can select multiple categories by entering numbers separated by commas"
    echo "Example: 1,3,4 or 2,5,7"
    echo ""
    echo "---------------------------------------------------------------"
    read -p "Enter your selection (or 'n' to skip): " tool_selection
    
    # Check if user wants to skip
    if [[ "$tool_selection" == 'n' || "$tool_selection" == 'N' || -z "$tool_selection" ]]; then
        log_warning "Skipping tool installation..."
        return
    fi
    
    # Normalize input: remove spaces, convert to array
    tool_selection=$(echo "$tool_selection" | tr -d ' ' | tr ',' ' ')
    read -a selections <<< "$tool_selection"
    
    # Define tool categories
    declare -A tool_categories=(
        ["1"]="Cracking"
        ["2"]="Network"
        ["3"]="Forensics"
        ["4"]="pwn"
        ["5"]="Wireless"
        ["6"]="OSINT"
        ["7"]="Mobile"
        ["8"]="Malware"
        ["9"]="Master"
    )
    
    # Track what we're installing
    local tools_to_install=()
    local install_count=0
    
    # Process selections
    for selection in "${selections[@]}"; do
        if [[ -n "${tool_categories[$selection]}" ]]; then
            tools_to_install+=("${tool_categories[$selection]}")
            ((install_count++))
        else
            log_warning "Invalid selection: $selection (skipping)"
        fi
    done
    
    if [[ $install_count -eq 0 ]]; then
        log_warning "No valid selections made. Skipping tool installation..."
        return
    fi
    
    # Install selected tools
    print_info "Installing selected tool categories..."
    echo "---------------------------------------------------------------"
    
    for tool_category in "${tools_to_install[@]}"; do
        print_info "Installing $tool_category tools..."
        if curl -O "$GITHUB/hArch/refs/heads/main/Tools/$tool_category" >/dev/null 2>&1; then
            if [[ -f "/$tool_category" ]]; then
                pacman -S - < "/$tool_category" --noconfirm
                rm "/$tool_category"
                print_info "✓ $tool_category tools installed"
            else
                log_error "Failed to download $tool_category tool list"
            fi
        else
            log_error "Failed to download $tool_category from GitHub"
        fi
        echo ""
    done
    
    echo "---------------------------------------------------------------"
    log_success "Tool installation completed!"
    sleep 2
    
}


function ad_Install {
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Active Directory Domain Join"
    echo "-------------------------------------------------------------------------------------------------"
    read -p "Join this system to an Active Directory domain? [y/N]: " JOIN_AD
    
    if [[ "$JOIN_AD" != 'y' && "$JOIN_AD" != 'Y' ]]; then
        log_warning "Skipping Active Directory domain join..."
        return
    fi
    
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Active Directory Configuration"
    echo "-------------------------------------------------------------------------------------------------"
    
    # Collect domain information
    read -p "Enter domain name (e.g., example.com or example.local): " DOMAIN_NAME
    if [[ -z "$DOMAIN_NAME" ]]; then
        log_error "Domain name is required. Skipping AD join..."
        return
    fi
    
    # DC IP is required for DNS resolution (especially for .local domains)
    read -p "Enter domain controller IP address (required): " DC_IP
    if [[ -z "$DC_IP" ]]; then
        log_error "Domain controller IP is required for DNS resolution. Skipping AD join..."
        return
    fi
    
    # Validate IP format (basic check)
    if ! [[ $DC_IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        log_error "Invalid IP address format. Skipping AD join..."
        return
    fi
    
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Domain Join Credentials"
    echo "Note: The account must have permissions to join computers to the domain"
    echo "-------------------------------------------------------------------------------------------------"
    read -p "Enter AD username (e.g., administrator or DOMAIN\\username): " AD_USERNAME
    if [[ -z "$AD_USERNAME" ]]; then
        log_error "Username is required. Skipping AD join..."
        return
    fi
    
    read -sp "Enter AD password: " AD_PASSWORD
    echo ""
    
    if [[ -z "$AD_PASSWORD" ]]; then
        log_error "Password is required. Skipping AD join..."
        return
    fi
    
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Installing Active Directory components..."
    echo "-------------------------------------------------------------------------------------------------"
    
    # Install packages from main repositories
    print_info "Installing sssd, krb5, samba, and ntp from main repositories..."
    pacman -S sssd krb5 samba ntp --noconfirm >/dev/null 2>&1
    
    if [[ $? -ne 0 ]]; then
        log_error "Failed to install AD packages from main repos. Skipping AD join..."
        return
    fi
    
    # Configure DNS FIRST - critical for domain resolution (especially .local domains)
    print_info "Configuring DNS to use domain controller..."
    # Backup existing resolv.conf
    if [[ -f /etc/resolv.conf ]]; then
        cp /etc/resolv.conf /etc/resolv.conf.backup
    fi
    
    # Configure resolv.conf with DC as primary nameserver
    echo "nameserver $DC_IP" > /etc/resolv.conf
    echo "search $DOMAIN_NAME" >> /etc/resolv.conf
    
    # Add DC to /etc/hosts for redundancy and .local domain support
    print_info "Adding domain controller to /etc/hosts..."
    # Remove any existing entries for this domain
    sed -i "/$DOMAIN_NAME/d" /etc/hosts 2>/dev/null
    # Add new entry
    echo "$DC_IP $DOMAIN_NAME" >> /etc/hosts
    # Also add short domain name if it's a .local or has a short name
    DOMAIN_SHORT=$(echo "$DOMAIN_NAME" | cut -d. -f1)
    if [[ "$DOMAIN_NAME" == *".local"* ]] || [[ -n "$DOMAIN_SHORT" ]]; then
        echo "$DC_IP $DOMAIN_SHORT" >> /etc/hosts
    fi
    
    print_info "✓ DNS and hosts file configured"
    
    # Configure NTP (critical for AD - must be done before domain join)
    print_info "Configuring NTP for time synchronization..."
    systemctl enable ntpd
    systemctl start ntpd
    timedatectl set-ntp true
    sleep 2  # Give NTP a moment to sync
    
    # Test DNS resolution
    print_info "Testing DNS resolution for domain..."
    if nslookup "$DOMAIN_NAME" >/dev/null 2>&1; then
        print_info "✓ DNS resolution successful for $DOMAIN_NAME"
    else
        log_warning "DNS resolution test failed, but continuing with hosts file entry..."
    fi
    
    # Install AUR packages (realmd and adcli) - must build as non-root user
    print_info "Installing realmd and adcli from AUR (this may take a few minutes)..."
    print_info "Note: AUR packages must be built as a non-root user"
    
    
    # Install realmd from AUR
    print_info "Building realmd from AUR..."
    if [[ -d "/home/$USERNAME/AUR/realmd" ]]; then
        rm -rf /home/$USERNAME/AUR/realmd
    fi
    sudo -u $USERNAME git clone "https://aur.archlinux.org/realmd.git" /home/$USERNAME/AUR/realmd >/dev/null 2>&1
    if [[ $? -eq 0 ]]; then
        cd /home/$USERNAME/AUR/realmd
        if sudo -u $USERNAME makepkg -si --noconfirm >/dev/null 2>&1; then
            print_info "✓ realmd installed successfully"
        else
            log_error "Failed to build realmd from AUR"
            cd -
            return
        fi
        cd -
    else
        log_error "Failed to clone realmd from AUR"
        return
    fi
    
    # Install adcli from AUR
    print_info "Building adcli from AUR..."
    if [[ -d "/home/$USERNAME/AUR/adcli-git" ]]; then
        rm -rf /home/$USERNAME/AUR/adcli-git
    fi
    sudo -u $USERNAME git clone "https://aur.archlinux.org/adcli-git.git" /home/$USERNAME/AUR/adcli-git >/dev/null 2>&1
    if [[ $? -eq 0 ]]; then
        cd /home/$USERNAME/AUR/adcli-git
        if sudo -u $USERNAME makepkg -si --noconfirm >/dev/null 2>&1; then
            print_info "✓ adcli installed successfully"
        else
            log_error "Failed to build adcli from AUR"
            cd -
            return
        fi
        cd -
    else
        log_error "Failed to clone adcli from AUR"
        return
    fi
    
    # Discover realm (now that DNS is configured)
    print_info "Discovering realm information..."
    if ! realm discover "$DOMAIN_NAME" >/dev/null 2>&1; then
        log_warning "Realm discovery had issues, but continuing with manual join..."
    else
        print_info "✓ Realm discovery successful"
    fi
    
    # Join domain
    echo "-------------------------------------------------------------------------------------------------"
    print_info "Attempting to join domain: $DOMAIN_NAME"
    print_info "Domain Controller: $DC_IP"
    print_info "This may take a moment..."
    echo "-------------------------------------------------------------------------------------------------"
    
    # Use realm join with credentials
    # Format username properly if not already formatted
    if [[ "$AD_USERNAME" != *"\\"* ]] && [[ "$AD_USERNAME" != *"@"* ]]; then
        AD_USERNAME_FULL="$AD_USERNAME@$DOMAIN_NAME"
    else
        AD_USERNAME_FULL="$AD_USERNAME"
    fi
    
    # Join domain using realm
    if echo "$AD_PASSWORD" | realm join --user="$AD_USERNAME_FULL" "$DOMAIN_NAME" --unattended; then
        print_info "✓ Successfully joined domain: $DOMAIN_NAME"
        
        # Configure SSSD
        print_info "Configuring SSSD..."
        systemctl enable sssd
        systemctl start sssd
        
        # Configure Samba
        print_info "Configuring Samba for AD integration..."
        systemctl enable smb
        systemctl enable nmb
        systemctl start smb
        systemctl start nmb
        
        # Update nsswitch.conf for AD authentication
        print_info "Updating nsswitch.conf for AD authentication..."
        if ! grep -q "sss" /etc/nsswitch.conf; then
            sed -i 's/^passwd:.*/passwd: files sss/' /etc/nsswitch.conf
            sed -i 's/^group:.*/group: files sss/' /etc/nsswitch.conf
            sed -i 's/^shadow:.*/shadow: files sss/' /etc/nsswitch.conf
        fi
        
        # Configure sudoers for domain admins (optional)
        print_info "Configuring sudo access for Domain Admins..."
        if ! grep -q "%Domain Admins" /etc/sudoers.d/domain_admins 2>/dev/null; then
            echo "%Domain\\ Admins ALL=(ALL) ALL" > /etc/sudoers.d/domain_admins
            chmod 440 /etc/sudoers.d/domain_admins
        fi
        
        # Test authentication
        print_info "Testing domain authentication..."
        if id "$AD_USERNAME_FULL" >/dev/null 2>&1; then
            print_info "✓ Domain authentication test successful"
        else
            log_warning "Domain authentication test had issues, but domain join completed"
        fi
        
        log_success "Active Directory domain join completed successfully!"
        print_info "Domain users can now log in using: username@$DOMAIN_NAME"
        print_info "You may need to reboot for all changes to take effect"
        
    else
        log_error "Failed to join domain: $DOMAIN_NAME"
        log_error "Please verify:"
        log_error "  - Domain name is correct"
        log_error "  - Domain controller IP ($DC_IP) is correct and reachable"
        log_error "  - Username and password are correct"
        log_error "  - Account has permissions to join computers to the domain"
        log_error "  - Network connectivity to domain controller"
        log_error "  - Time synchronization (NTP) is working"
        
        # Cleanup on failure
        print_info "Cleaning up failed configuration..."
        systemctl stop sssd 2>/dev/null
        systemctl disable sssd 2>/dev/null
        
        # Restore DNS if we modified it
        if [[ -f "/etc/resolv.conf.backup" ]]; then
            mv /etc/resolv.conf.backup /etc/resolv.conf
        fi
    fi
    
    # Clear password from memory
    unset AD_PASSWORD
    
    echo "-------------------------------------------------------------------------------------------------"
    sleep 3
}


function complete {
    slear
    echo "-------------------------------------------------------------------------------------------------"
    fastfetch
    echo "-------------------------------------------------------------------------------------------------"
    log_success "hArch has been successfully installed on your system"
    print_info "-------------------------------------------------------"
    print_info "Hack the Universe $USERNAME" x_X
    print_info "-------------------------------------------------------"
    log_warning "A reboot should now take place"
    print_info "Run the following commands to reboot properly:"
    log_warning "1: exit"
    log_warning "2: umount -a"
    log_warning "3: reboot"
    unset ROOT_PASSWORD USER_PASSWORD HOSTNAME USERNAME
    rm /hArchPost
    exit
}

function one_Func_To_Rule_Them_All {
    local funcs=($(and_In_The_Script_Bind_Them))

    for func in "${funcs[@]}"; do
        $func
        slear
    done
}

# Because why not...
function and_In_The_Script_Bind_Them {
    local encoded="cF9Eb3dubG9hZCBpbnN0YWxsZXIgdXNlcl9JbmZvIHZpZF9Ecml2ZXIgYm9vdGVyIGRlc2t0b3BfRW52IGJsYWNrX0FyY2ggaGFja19Ub29scyBkZXZfU2V0dXAgY29tcGxldGUK"
    
    # Too easy ;)
    echo "$encoded" | base64 --decode
}

collect_Inputs
slear
one_Func_To_Rule_Them_All