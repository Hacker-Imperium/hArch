if status is-interactive
    # Commands to run in interactive sessions can go here
end

function firstRun
    # Load MATE configuration from fish config directory
    if test -f ~/.config/fish/MateConfig
        dconf load /org/mate/ < ~/.config/fish/MateConfig
        echo "✓ MATE configuration loaded"
    else
        echo "Warning: MateConfig not found in ~/.config/fish/MateConfig"
    end
    
    # Set desktop background if not already set
    set BG_PATH "/usr/share/backgrounds/mate/desktop/linux-vs-windows.jpg"
    if test -f "$BG_PATH"
        gsettings set org.mate.background picture-filename "$BG_PATH"
        echo "✓ Desktop background set to linux-vs-windows.jpg"
    else
        echo "Warning: Background image not found at $BG_PATH"
    end
    
    sleep 1
    sudo systemctl start dhcpcd
    sleep 30

    set -l eth (ip link show | grep -E 'en[[:alnum:]]' | grep 'state UP')

    set -l wifi (ip link show | grep -E 'wl[[:alnum:]]' | grep 'state UP')

    if test -z "$eth" -a -z "$wifi"
        echo "No active Ethernet or WiFi connection found. Please connect to a network and try again."
        return 1
    end

    sudo pacman -Syu --noconfirm
end

function startUp
	sudo systemctl start dhcpcd
    sleep 15
    sudo pacman -Syu --noconfirm
end

function installHaskell
    set -x BOOTSTRAP_HASKELL_NONINTERACTIVE 1
    curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh
end

function rebuild
    cabal clean && cabal build
end

function record
	ffmpeg -f x11grab -video_size 1920x1080 -framerate 25 -i $DISPLAY -c:v ffvhuff $argv
end

function newHasky
    if test -z $argv[1]
        echo "Usage: newHasky <project-name>"
        return 1
    end
  
    set project_name $argv[1]
    set project_dir (realpath $project_name)

    mkdir -p $project_dir
    cd $project_dir

    mkdir -p src/ test/ app/

    echo "# $project_name" > README.md

    echo "MIT License" > LICENSE

    echo "/dist-newstyle/" > .gitignore

    echo "cabal-version:  3.0
name:           $project_name
version:        0.1.0.0
license:        MIT
build-type:     Simple

library
  exposed-modules:
      Lib
  hs-source-dirs:
      src
  build-depends:
      base >= 3 && < 7
  default-language: Haskell2010

executable $project_name
  hs-source-dirs:  app
  main-is:         Main.hs
  build-depends:   base >= 3 && < 7
                   , $project_name
  default-language: Haskell2010" > "$project_name.cabal"

    echo "module Main where

import Lib (someFunc)

main :: IO ()
main = someFunc" > app/Main.hs

    echo "module Lib
    ( someFunc
    ) where

someFunc :: IO ()
someFunc = putStrLn \"Project Setup!\"" > src/Lib.hs
    
    echo "main :: IO ()
main = putStrLn \"Test suite not yet implemented\"" > test/Test.hs

    cabal build
    cabal run $project_name

    echo "Created new Haskell Lib project '$project_name' in $project_dir"
end

function newPy 
    if test -z $argv[1]
        echo "Usage: newPy <project-name>"
        return 1
    end
  
    set py_name $argv[1]
    set py_dir (realpath $py_name)

    mkdir -p $py_dir
    cd $py_dir

    mkdir -p tests/ app/  

    echo "# $py_name" > README.md

    echo "#!/usr/bin/env python3" > setup.py

    echo "#!/usr/bin/env python3" > app/__init__.py

    echo "#!/usr/bin/env python3" > app/__main__.py

    echo "#!/usr/bin/env python3" > utils.py

    echo "Created new Python project '$py_name' in $py_dir"
end

function join-AD
    echo "-------------------------------------------------------------------------------------------------"
    echo "Active Directory Domain Join"
    echo "-------------------------------------------------------------------------------------------------"
    
    # Check if Samba is configured
    if not test -f /etc/samba/smb.conf
        echo "Error: Samba not configured. Please run ad_Install in hArchPost first."
        return 1
    end
    
    # Get domain info from smb.conf (using sudo to read)
    set DOMAIN_NAME (sudo grep -E '^[[:space:]]*realm[[:space:]]*=' /etc/samba/smb.conf | sed 's/.*=[[:space:]]*//' | tr '[:upper:]' '[:lower:]')
    set NETBIOS_NAME (sudo grep -E '^[[:space:]]*workgroup[[:space:]]*=' /etc/samba/smb.conf | sed 's/.*=[[:space:]]*//')
    
    if test -z "$DOMAIN_NAME"
        echo "Error: Could not determine domain name from /etc/samba/smb.conf"
        return 1
    end
    
    echo "Detected domain: $DOMAIN_NAME"
    echo "NetBIOS name: $NETBIOS_NAME"
    echo ""
    
    # Start required services (winbind will be started AFTER domain join)
    echo "Starting required services..."
    sudo systemctl start ntpd
    sleep 2
    sudo timedatectl set-ntp true
    
    # Start smb and nmb (these can start before domain join)
    # DO NOT start winbind yet - it requires domain join first
    sudo systemctl start smb
    sudo systemctl start nmb
    
    # Get credentials
    read -P "Enter AD username (e.g., administrator): " AD_USERNAME
    if test -z "$AD_USERNAME"
        echo "Error: Username is required"
        return 1
    end
    
    read -sP "Enter AD password: " AD_PASSWORD
    echo ""
    if test -z "$AD_PASSWORD"
        echo "Error: Password is required"
        return 1
    end
    
    # Format username (remove domain prefix if present)
    # Fish requires different escaping for sed - use string replace instead
    set AD_USERNAME_FULL (string replace -r '.*\\' '' "$AD_USERNAME")
    set AD_USERNAME_FULL (string replace -r '@.*' '' "$AD_USERNAME_FULL")
    
    # Join domain
    echo "-------------------------------------------------------------------------------------------------"
    echo "Attempting to join domain: $DOMAIN_NAME"
    echo "This may take a moment..."
    echo "-------------------------------------------------------------------------------------------------"
    
    if echo "$AD_PASSWORD" | sudo net ads join -U "$AD_USERNAME_FULL"
        echo "✓ Successfully joined domain: $DOMAIN_NAME"
        
        # Wait a moment for domain join to fully complete
        sleep 2
        
        # Restart smb and nmb to pick up domain membership
        echo "Restarting Samba services..."
        sudo systemctl restart smb
        sudo systemctl restart nmb
        
        # Now start winbind (it requires domain join to be complete)
        echo "Starting winbind service..."
        sudo systemctl start winbind
        
        # Give winbind a moment to initialize
        sleep 3
        
        # Check winbind status
        if sudo systemctl is-active --quiet winbind
            echo "✓ Winbind service started successfully"
        else
            echo "Warning: Winbind service may not be running properly"
            echo "Checking winbind status..."
            sudo systemctl status winbind --no-pager -l
        end
        
        # Test connectivity and winbind functionality
        echo "Testing domain connectivity..."
        sleep 2  # Give winbind more time to initialize
        
        # Try to get domain info
        if sudo wbinfo -t >/dev/null 2>&1
            echo "✓ Winbind trust relationship verified"
        else
            echo "Warning: Winbind trust relationship test failed"
            echo "This may indicate the domain join didn't complete properly"
        end
        
        # Test user enumeration
        if sudo wbinfo -u >/dev/null 2>&1
            echo "✓ Domain connectivity test successful"
            echo "Domain users available:"
            sudo wbinfo -u | head -n 5
        else
            echo "Warning: Domain connectivity test had issues"
            echo "Troubleshooting steps:"
            echo "  1. Check winbind service: sudo systemctl status winbind"
            echo "  2. Check winbind logs: sudo journalctl -u winbind -n 50"
            echo "  3. Verify domain join: sudo net ads testjoin"
            echo "  4. Check DNS resolution: nslookup $DOMAIN_NAME"
            echo "  5. Verify time sync: timedatectl status"
        end
        
        if sudo wbinfo -g >/dev/null 2>&1
            echo "Domain groups available:"
            sudo wbinfo -g | head -n 5
        end
        
        # Additional diagnostic
        echo ""
        echo "Running diagnostic checks..."
        if sudo net ads testjoin >/dev/null 2>&1
            echo "✓ Domain join verified with 'net ads testjoin'"
        else
            echo "Warning: 'net ads testjoin' failed - domain join may not be complete"
        end
        
        echo ""
        echo "✓ Active Directory domain join completed successfully!"
        echo "Domain users can now log in using: $NETBIOS_NAME\\username or username@$DOMAIN_NAME"
        echo "You may need to reboot for all changes to take effect"
        
        # Clear password
        set -e AD_PASSWORD
    else
        echo "Error: Failed to join domain: $DOMAIN_NAME"
        echo "Please verify:"
        echo "  - Domain name is correct"
        echo "  - Username and password are correct"
        echo "  - Account has permissions to join computers to the domain"
        echo "  - Network connectivity to domain controller"
        echo "  - Time synchronization (NTP) is working"
        echo "  - DNS resolution is working"
        
        # Clear password
        set -e AD_PASSWORD
        return 1
    end
end

set PATH $HOME/.local/bin $PATH

set -q GHCUP_INSTALL_BASE_PREFIX[1]; or set GHCUP_INSTALL_BASE_PREFIX $HOME ; set -gx PATH $HOME/.cabal/bin $PATH $HOME/.ghcup/bin
